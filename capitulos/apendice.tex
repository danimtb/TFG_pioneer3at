\appendix
\addappheadtotoc
\appendixpage
\chapter{Configuración del sistema} \label{chapter:configuracion_sistema}

En este apéndice se resume de manera simplificada y muy enfocada la configuración completa del sistema robótico objeto de este trabajo, tanto la parte referente al software de robot como la parte destinada a la configuración hardware de todos los equipos que incorpora.

\section{Configuración del espacio de trabajo}
En ROS el espacio de trabajo es el lugar donde se realiza el desarrollo software de los paquetes ROS. Este en torno de trabajo es capaz de gestionar la correcta compilación de los nodos.

El espacio de trabajo es el determinado por la herramienta Catkin. A partir de la versión Indigo de ROS, casi todos los paquetes se encuentran adaptados al entorno Catkin y funcionan de manera casi inmediata.

A continuación se describen los pasos para crear un espacio de trabajo Catkin (extraídos del tutorial *TAL*) y los pasos para clonar el repositorio de GitHub que aloja el código.

Tras instalar ROS en el equipo deseado, instalamos Catkin:

\begin{code}[htp]
\begin{lstlisting}[style=consola]
$ sudo apt-get install ros-indigo-catkin
$ mkdir -p ~/catkin_ws/src
$ cd ~/catkin_ws/src
$ catkin_init_workspace
\end{lstlisting}
\caption{Instalación y workspace de Catkin}
\end{code}

A continuación inncluimos el directorio de desarrollo para que sea reconocido por ROS a la hora de buscar dependencias:

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ cd ~/catkin_ws
$ source devel/setup.bash
\end{lstlisting}
\caption{Source al setup de nuestro entorno Catkin}
\end{code}

\subsection{Instalación de las librerías}

Para clonar el desarrollo software de este proyecto bastaría con clonar el repositorio de GitHUb en el que se ha trabajado en este proyecto \url{https://github.com/danimtb/pioneer3at_ETSIDI} en nuestra carpeta \textit{$\sim$/catkin\_ws/src}.

\begin{code}[htp]
\begin{lstlisting}[style=consola]
$ cd ~/catkin_ws/src
$ $ git clone --recursive https://github.com/danimtb/pioneer3at_ETSIDI.git .
\end{lstlisting}
\hypersetup{urlcolor=black}
Fuente: \href{https://github.com/danimtb/pioneer3at_ETSIDI}{\textit{https://github.com/danimtb/pioneer3at\_ETSIDI}}
\hypersetup{urlcolor=blue}
\caption{Clonado del repositorio \textit{pioneer3at\_ETSIDI}}
\end{code}

Sin embargo, es recomendable que si se desea realizar algún desarrollo posterior, se realice un fork en GitHub de este proyecto (Figura *TAL*) y se clone el repositorio propio.

**Captura de pantalla del repo github**

De esta forma podemos guardar los cambios realizados en el repositorio de la persona que hace la modificación, con la intención de incorporar los cambios más tarde al repositorio de desarrollo principal (\url{https://github.com/danimtb/pioneer3at_ETSIDI.git}) mediante Pull Request.

**figura pull request**


\subsection{Gestión de las dependencias}

 ROS se vale de la información almacenada en la definición de cada uno de sus paquetes en \textit{package.xml} y gestionar algunas dependencias de librerías, para lo cual se sirve de la herramienta rosdep **referencia** creada por los desarrolladores de ROS para este propósito.

Para comenzar a utilizarla inicializamos rosdep y actualizamos las dependencias:

\begin{code}[htp]
\begin{lstlisting}[style=consola]
$ sudo rosdep init
$ rosdep update
\end{lstlisting}
\caption{Inicializando la herramienta \textit{rosdep}.}
\end{code}

A continuación se describen los pasos necesarios para instalar las dependencias de cada sección:

\begin{itemize}
\item Navegación: Instalamos los paquetes adicionales para realizar la navegación y mapeo (Capítulo \ref{chapter:navegacion}).
\end{itemize}

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ sudo apt-get install ros-indigo-navigation
$ sudo apt-get install ros-indigo-gmapping
\end{lstlisting}
\caption{Instalando los paquetes de navegación mapeo.}
\end{code}

\begin{itemize}
\item Rosaria: Instalamos las dependencias de RosAria, principalmente la librería Aria.
\end{itemize}

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ rosdep install rosaria
\end{lstlisting}
\caption{Instalando las dependencias de rosaria.}
\end{code}


Para el reconocimiento de los comandos de voz utilizamos el paquete \textit{pocketsphinx}:

\begin{itemize}
\item pocketsphinx: Instalamos los paquetes de conversion a texto y buscamos las dependencias del paquete.
\end{itemize}

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ sudo apt-get install gstreamer0.10-gconf
$ rosdep install pocketsphinx
\end{lstlisting}
\caption{Instalando las dependencias de \textit{pocketsphinx} y \textit{gstreamer}.}
\end{code}

Es posible que necesitemos las dependencias añadidar de \textit{audio\_capture}.

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ rosdep install audio_capture
\end{lstlisting}
\caption{Instalando las dependencias de \textit{audio\_capture}.}
\end{code}

Para el audio (sintetizado de voz) utilizamos el nodo \textit{sound\_play}, por lo que debemos instalar sus dependencias.

\begin{itemize}
\item sound\_play: Nodo para el sintetizado de voz y reproducir sonidos.
\end{itemize}

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ rosdep install sound_play
\end{lstlisting}
\caption{Instalando las dependencias de \textit{sound\_play}.}
\end{code}

Una vez disponemos de todos los paquetes y sus respectivas dependencias no debemos olvidarnos de que es necesario compilarlos:

\begin{code}[!htp]
\begin{lstlisting}[style=consola]
$ cd ~/catkin_ws
$ catkin_make
\end{lstlisting}
\caption{Compilando los paquetes del espacio de trabajo Catkin.}
\end{code}


\section{Configuración del hardware}

En este apéndice se describen algunos ajustes útiles del hardware que se ha utilizado en el proyecto. Esta información es importante para que el sistema robótico desarrollado funcione pero no ha sido incluida dentro del cuerpo de la memoria para no alargar las explicaciones.

En cualquier caso, los procemientos que a continuación se describen es probable que no sea necesarioz volver a realizarlos en futuros usos del robot si se mantiene la configuración descrita en este trabajo.

\subsection{Calibración de la odometría}\label{subsection:odometria}
La lectura de la posición de los motores del robot se realiza mediante unos encoders situados en el eje de cada motor.

El firmware ARCOS de la placa controladora del robot es actualizable y gestiona os parámetros de calibración de la odometría. Este firmware es actualizable aunque para ello es necesario ponerse en contacto con el fabricante Adept.

Estos parámetros referentes a la odometría son configurables a través de la librería Aria en caso de que no se desee acceder a modificar el firmware del robot.

Los parámetros a considerar son los siguientes:

\begin{itemize}
\item TicksMM
\item DriftFactor
\item RevCount
\end{itemize}

El nodo de ROS RosAria es capaz de pasar estos parámetros a la placa controladora del robot a través de Aria. Es por ello que podemos configurar dinámicamente estos parámetros del robot cada vez que ejecutamos el nodo. De esta forma evitamos tener que recurrir a Adept y a software específico para modificar los parámetros de ARCOS.

Podemos ver la descripción de estos parámetros en el manual del robot Pioneer 3 AT **referencia**

**IMAGEN DEL MANUAL**

EL procedimiento para calcular cada uno de estos parámetros es el siguiente:



\subsection{Ordenador de abordo Intel NUC}

\subsection{Sensor Kinect}
El sensor Kinect utilizado en el proyecto no dispone de ninguna moficiación específica o modo de funcionamiento especial. Lo referente a su conexionado ha sido descrito anteriormente en la sección \label{subsection:implementacion_kinect}.

Tan solo indicar que puede realizarse una primera toma de contacto a través de la librería \textit{libfreenect}. Una manera rápida de hacerlo es utilizando el gestor de depencencias en C++ biicode **LINK A BIICODE**, en un sistema operativo Ubuntu siguiendo esta guía **URL DE BIICODE**.

\subsection{Láser SICK LMS100}\label{subsection:sicklms100_apendice}

El sensor láser LMS100 de la marca Sick es un sensor de ampli rango y largo alcance de tipo industrial.

El fabricante Sick ofrece un software propietario llamado SOPAS Ingineering Tool que permite acceder a la configuración interna del sensor. Este software tan solo puede utilizarse bajo el sistema operativo Microsoft Windows, en concreto ha sido utilizado con Windows 7.

Para instalarlo hay que recurrir a la web del fabricante: **COMPLETAR**

Para configurar el dispositivo debemos enchufarlo a un puerto Ethernet de un ordenador con el software instalado y proporcionarle alimentación.

El puerto ethernet del ordenador debe estar configurado para obtener una IP automática. Una vez aparezca la red como conectada procedemos a abrir el software SOPAS.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.8\textwidth]{figuras/sopas1.png}
\caption{Software Sick SOPAS con el sensor detectado.}
\label{fig:sopas1}
\end{figure}

Automáticamente detectará el dispositivo pero seguramente no podamos acceder a él debido a una dirección IP errónea.

Para ello abriremos el apartado de configuración y selecionamos ''Asignar IP automáticamente" para que nos asigne el rango adecuado.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.8\textwidth]{figuras/sopas2.png}
\caption{Configurando la dirección IP del dispositivo.}
\label{fig:sopas2}
\end{figure}

Si queremos una dirección IP de determinado rango, la mejor manera de proceder es asignar al adaptador de red del ordenador una IP manual del rango deseado y realizar el procedimiento anterior.

También podemos acceder a los parámetros del sensor y visualizar en un gráfico la información que está captando en el momento.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.8\textwidth]{figuras/sopas3.png}
\caption{Gráfico de la información captada por el sensor en el software SOPAS.}
\label{fig:sopas3}
\end{figure}

A partir de aquí podremos conectarnos al láser con el nodo ROS LMS1xx, configurando una IP fija en el adaptador de red ethernet del ordenador al que lo conectemos, en este caso el ordenador Intel NUC del robot.

\begin{itemize}
\item Dirección IP del láser Sick LMS100:
\item Dirección IP del adaptador ethernet del ordenador Intel NUC: 
\end{itemize}

Para más información conviene leer el manual que ofrece Sick \cite{sicklms100}.

\chapter{Manual de uso del robot}
Este apéndice es una guía de funcionamiento del robot Pioneer 3 AT (Petrois) utilizado e implementado al acabar este proyecto fin de grado.

\section{Encendido del robot}
El robot se enciende mediante un interruptor situado en su parte trasera, el cual proporciona alimentación general a todos los sistemas.

Adicionalmente es necesario encender el ordenador de abordo Intel NUC mediante su correspondiente botón y el altavoz frontal del robot, para lo cual será necesario tener activada la alimentación auxiliar 2 (AUX 2) en el panel de control.

**DESCRIPCION ENCENDIDO INTEL NUC**

\section{Panel de control y parada de emergencia}
El panel de control del robot se sitúa en su lateral derecho. Aquí disponemos de una serie de botones, indicadores luminosos, acústicos y conexiones.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.6\textwidth]{figuras/panel_derecho.jpg}
\caption{Panel de control del robot Petrois.}
\label{fig:panel_derecho}
\end{figure}

A continuación se describe cada uno de los elementos de la figura \ref{fig:panel_derecho}:
\begin{itemize}
\item Pulsador MOTORS: Encargado de habilitar y deshabilitar los motores del robot. La activación de los mismos puede realizarse a través de software. Es necesario pulsar este botón para rearmar el robot cuando se pulsa la seta de emergencia. Si se pulsa una vez más el robot realiza una secuencia de movimientos para comprobar que los motores funcionan correctamente.
\item Pulsador RESET: Resetea la placa controladora del robot. El robot queda su estado inicial, tal y como si lo acabásemos de encender. Al pulsar este botón se interrumpe cualquier comunicación con la placa de control.
\item Pulsador AUX 1: Habilita la alimentación 1 de la placa de alimentación. No se encuentra en uso.
\item Pulsador AUX 2: Habilita la alimentación 2 de la placa de alimentación. Es necesario tenerlo habilitado para que el altavoz frontal del robot funcione.
\item LED PWR: Indica el estado de los motores.
\item LED STATUS: Indica el estado del robot.
\item LED BATERY: Indica el estado de carga de la batería.
\item LEDs AUX 1 y AUX 2: Indica si las alimentaciones auxiliares se encuentran activas.
\item LEDs RX y TX: Muestran el estado de la comunicación con la placa de control.
\item SERIAL: Puerto RS-232 que comunica con la placa de control. Puede ser utilizado para conectar un ordeandor externo directamente la placa de control del robot.
\end{itemize}

Muchos de los estados anteriores se indican mediante una señal acústica. El reseteo de la placa tiene un sonido característico al igual que cuando se pierde la conexión con la placa de control.

El pulsador de emergencia se encuentra en la parte superior del robot y es de vital importancia cuando el robot se mueve de manera descontrolada, choca o está en peligro la integridad de una persona o del propio robot. Es por ello que se recomienda su uso siempre que se encuentre en una situación de las anteriores.

**imagen de la seta de emergencia**

Al pulsar la seta de emergencia ésta quedará enclavada y el robot dará una señal acústica continuada indicando que se encuentra en parada. En este punto los motores quedan deshabilitados y las ruedas del robot pueden moverse libremente.

Para rearmar el robot basta con devolver la seta de emergencia a su posición original girando levemente la misma en el sentido de las flechas. Después es necesario pulsar el botón MOTORS para volver a habilitar los motores.

Cabe indicar que la comunicación de cualquier ordenador con la placa de control del robot no se interrumpe, por lo que al rearmar el robot es posible que éste continúe con los movimientos previos a la parada de emergencia. Asegúrese de que las consignas de movimiento son las correctas y ponga especial precaución cuando realice el rearmado del robot.

Para información más extensa y detallada se recomienda leer la guía de usuario ofrecida por el fabricante **REFERENCIA**.

\section{Conexión mediante un ordenador externo vía Wifi}

Al encender el ordenador Intel NUC, éste está configurado para generar directamente un HotSpot Wifi o red Ad-hoc con el nombre "P3AT". Esta red Wifi maneja direcciones IP en el rango 10.42.0.X por lo que es recomendable conectarse a ella con una IP fija que esté dentro de ese rango. SU contraseña es "pioneer3at"

Si se está ejecutando el nodo MASTER en el ordenador Intel NUC, éste estará configurado con la IP 10.42.0.1. Para indicar que queremos conectarnos a un nodo MASTER que se ejecuta en otra máquina debemos editar el script \textit{.bashrc} del ordenador externo, que se ejecuta siempre que abrimos una terminal.

Para editarlo, abrimos la terminal y escribimos:

\begin{code}[htp]
\begin{lstlisting}[style=consola]
$ gedit ~/.bashrc
\end{lstlisting}
\caption{Abriendo el \textit{.bashrc}.}
\end{code}

Una vez abierto, al final del archivo añadimos las siguientes dos líneas:

\begin{code}[htp]
\begin{lstlisting}[style=consola]
export ROS_IP=10.42.0.77
export ROS_MASTER_URI=http://10.42.0.1:11311
\end{lstlisting}
\caption{Añadidendo las direcciones IP al \textit{.bashrc}.}
\end{code}

La primera línea indica la IP fija con la que el ordenador externo se conecta a la red Ad-hoc del Intel NUC. Modificar la IP y escribir la IP del ordeandor externo.
La dirección IP del MASTER es la dirección que está configurada en el Intel NUC y a la que tratarán de conectarse los nodos cuando se lancen desde el ordenador externo.

Este procedimiento está hecho igual en el Intel NUC pero indicando tan solo que la IP de ese equipo es \textbf{ROS\_IP=10.42.0.77}.

\section{Acceder a la placa de alimentación}

La placa de alimentación se encuentra bajo la tapa negra principal del robot, justo debajo del sensor Kinect.

Su posición no es muy accesible y se recomienda encarecidamente leer el manual para tener acceso a la misma.

Por otro lado, siempre puede acderse a la alimetación de 12 voltios a través del cable de alimentación del sensor Kinect y a 5 voltios a través de los cables de alimentación del altavoz delantero.

\section{Cargar las baterías del robot}
El robot Pioneer 3 AT dispone de un pack de 3 baterías estáncas de plomo-ácido a 12 voltios. Estas baterías suministran alimentación a todos los sistemas del robot y proporcionan una autonomía aproximada de 2 horas de funcionamiento.

El acceso a las baterías se encuentra en el interior del chasis del robot y son accesibles mediante una trampilla trasera.

**IMAGEN**

La carga de las baterías se realiza con el adaptador de la figura **TAL** a través del conector de carga situado junto al interruptor de alimentación general.

**Imagen del cargador**

No ha podido estimarse el tiempo de carga completo, sin embargo el propio cargador incorpora un indicador luminoso que muestra el estado de carga de las baterías.

\section{Ordenador interno del Pioneer 3 AT}

EL ordenador interno del robot Pioneer 3 AT se encuentra en desuso.

Todos los controles necesarios para acceder al ordenador están disponibles a través del panel situado en el lateral izquierdo del robot.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.5\textwidth]{figuras/panel_izquierdo.png}
\caption{Panel del ordenador interno (lateral izquierdo) del robot Petrois.}
\label{fig:panel_izquierdo}
\end{figure}

En este lateral encontramos elementos adicionales como la antena de conexión wifi del ordenador interno y el acceso a los puertos USB y Jacks de micrófono y auriculares.

\textbf{IMPORTANTE:}\\
Originalmente este ordenador se encontraba conectado a la placa controladora del robot de manera interna a través el puerto COM1 (Accesible en el interior del robot). En su lugar se conectó el convertidor de RS-232 a USB utilizado con el ordeandor Intel NUC, por lo que el ordenador interno se encuentra desconectado del robot.

\textbf{IMPORTANTE:}\\
Uno de los ventiladores internos situado en la parte frontal derecha del robot fue desconectado debido a su elevado ruido y su encendido permanente. En caso de utilizar el ordenador interno del robot es posible que sea necesario volver a conectarlo. Sin embargo no existe riesgo de sobrecaentamiento ya que el propio ordenador dispone de un ventilador adicional que se pone en marcha al encencerlo.


\chapter{Información y documentos ONLINE}
 En este apéndice se muestra información adicional de todo tipo referente al proyecto y a los materiales utilizados.

\section{Repositorio de código}
Como se ha descrito anteriormente, el repositorio de código desarrollado en ente proyecto se encuentra almacenado en GitHub. Puede consultarse su linea de tiempos, commits e incluso realizar preguntas en el apartado de Issues.

\url{https://github.com/danimtb/pioneer3at_ETSIDI}

**Imágen del repositorio**

En él podrá encontrar una pequeña guía \textit{Readme} actualizada con información sobre las utilidades que ofrece el repositorio y en concreto el desarrollo realizado en el paquete \textit{pioneer\_utils}, donde se encuentra la mayoría del desarrollo.

\subsection{Readme}
Copia del documento \textit{Readme} del repositiorio.

**COPIA**

\section{Preguntas en ROS Answers y Github}
Pregunta del láser
Preguntal del Intel Nuc

Issue cleapath robotics

\section{Multimedia}
Colección de vídeos:

\begin{itemize}
\item Vídeos de este proyecto:
\item Vídeos de antiguos proyectos:
\end{itemize}

Imágenes:
\begin{itemize}
\item Imágenes de este proyecto:
\item Imágenes de antiguos proyectos:
\end{itemize}

\section{Memoria del trabajo}

La memoria del trabajo ha sido desarrollada en \LaTeX, bajo el editor \textit{TexStudio} en un ordenador con sistema operativo GNU/Linux Ubuntu 14.04 LTS.

Su desarrollo ha sido puesto bajo un controlador de versiones y alojado en el siguiente repositorio de github:

\url{https://github.com/danimtb/TFG_pioneer3at}

En el propio repositorio se encuentran las figuras utilizadas y los archivos .tex, donde se ha escrito el mismo,  y la bibligrafía empleada.

El documento PDF compilado de \LaTeX puede consultarse en el siguiente enlace:

\url{https://github.com/danimtb/TFG_pioneer3at/TFG.pdf}