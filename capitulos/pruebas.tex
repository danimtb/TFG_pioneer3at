\chapter{Pruebas del sistema}
En este capítulo se describen las principales pruebas realizadas con el robot de tal modo que sirva para validar el trabajo realizado y exponer a los resultados obtenidos.

Dividimos este capítulo en dos partes, pruebas del robot en simulación y pruebas en el entorno real, centrándonos exclusivamente en la creación de mapas mediante SLAM y los tests de navegación.


\section{Pruebas simuladas}
La ventaja de disponer del simulador Gazebo funcionando con el modelo de nuestro robot permitió que el robot evolucionase más rápido debido a que los cambios se probaban de manera inmediata y que puedieran probarse otras configuraciones del robot, validarlas y finalmente implementarlo en el robot real.

Con la ayuda de Gazebo se han podido probar todas las configuraciones de navegación, el funcionamiento de cada nodo y el intercambio de datos entre ellos.

\subsection{SLAM}
Las pruebas de SLAM se realizaron con el ya mencionado paquete \textit{gmapping}, funcionando de la manera habitual.

Para comprobar su validez, se dispuso al robot en el mundo "Willow Garage" que simula un entorno de oficinas, similar al entorno real del laboratorio. El objetivo principal fue comprobar que el algoritmo de mapeado funcionaba correctamente y si se conseguía cerrar el mapa realizando un bucle completo.

Para esta prueba se utilizó el nodo de mapeado y el de teleoperación y se guió al robot por una parte del entorno realizando diversos bucles (Figura \ref{fig:slam_gazebo}), en los que se observa que no existe distorsión en paredes paralelas y que el mapa no se encuentra solapado.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.8\textwidth]{figuras/slam_gazebo.png}
\caption{Prueba de SLAM en el simulador Gazebo.}
\label{fig:slam_gazebo}
\end{figure}

Indicar que este fue el mapa base utilizado para la navegación de sucesivas pruebas con Gazebo en las cuales el nodo AMCL situó correctamente al robot en el entorno virtual, por lo que validación del mapa generado es correcta.

\subsection{Navegación con mapa}
Las navegaciones con mapa en el simulador fueron determinantes para realizar una configuración más elaborada de ambos costmaps debido a los problemas con el borrado de los obstáculos (ver Subsección \ref{subsection:configuracion_costmaps_sensores}).

En un principio se valoró la posibilidad de utilizar el sensor Kinect tan solo para obstáculos locales y el sensor láser para obstáculos globales, sin embargó se descartó ya que el robot trataba de seguir una trayectoria global incorrecta que no contemplaba los obstáculos bajos (Figura), con las complicaciones de control que eso supone para el planificador de trayectoria local.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.65\textwidth]{figuras/discrepancia_costmaps_gazebo.png}
\caption{Trayectoria global erronea.}
\label{fig:discrepancia_costmaps_gazebo}
\end{figure}

Esto determinó, junto con las características especiales del sensor Kinect, que los sensores fueran recolocados para la configuración final del robot y que se añadiesen capas de obstáculos diferenciadas para cada sensor.

Pruebas posteriores con la nueva configuración y obstáculos bajos determinaron la configuración correcta. Además se configuró un cálculo de trayectoria global repetitivo, de tal modo que el planificador global genera trayectorias actualizadas a medida que el robot incorpora los obstáculos al mapa. Esto ayuda al planificador local de trayectoria y en definitiva a que el robot realice menos maniobras.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.7\textwidth]{figuras/navegacion_global_gazebo.png}
\caption{Navegación con mapa final.}
\label{fig:navegacion_global_gazebo}
\end{figure}

\subsection{Navegación reactiva}
La nagación reactiva es una configuración menor de la anterior, por lo que no supuso un desarrollo más elaborado en las pruebas realizadas.

Consistieron en realizar navegación mandando al robot hacia varios puntos de meta y comprobar si se quedaba atascado en algún momento.

Las pruebas determinaron que el robot mostraba el mismo comportamiento en la navegación pero existían limitaciones como la distancia a la que pueden encontrarse los puntos de meta (puntos más cercanos al robot debido a la ausencia de mapa) o solapamientos y giros en el mapa global si este era demasiado grande.

Como es normal en una navegación reactiva, el robot se desplaza siguiendo la trayectoria más corta en base a la información que sus sensores captan en ese momento, por lo que suceden casos como en la figura *TAL*. A pesar de ello, gracias a la información de los obstáculos que queda retenida en el mapa global, el planificador recalcula.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.40\textwidth]{figuras/navegacion_local1_gazebop.png}
\includegraphics[width=0.40\textwidth]{figuras/navegacion_local2_gazebop.png}
\caption{Navegación con mapa final.}
\label{fig:navegacion_local_gazebo}
\end{figure}

\subsection{Pruebas de resistencia}
Para las pruebas de resistencia utilizamos un nodo desarrollado en Python específicamente creado para el caso.

En estas pruebas se consideraron los siguientes aspectos:
\begin{itemize}
\item Puntos de meta: Puntos totales repartidos por el mapa que serviran como puntos objetivo a alcanzar por el robot.
\item Tiempo total: Tiempo total de la prueba.
\item Metas enviadas: Número total de puntos de meta que se han enviado como objetivo al robot durante la prueba.
\item Metas alcanzadas: Número de metas a las que ha conseguido llegar el robot.
\item Tasa de metas alcanzadas: Tanto por ciento de las metas alcanzadas respecto de las enviadas.
\item Distancia total: Distancia total recorrida, considerando obstáculos intermedios y maniobras o replanificación de trayectorias del robot.
\item Nº de choques: Número de obstáculos con los que el robot ha chocado (si los hubiera).
\end{itemize}

Las pruebas de resistencia se realizaron en el modo de navegación con mapa, el entorno virtual fue el mundo "Willow Garage" y se utilizaron un total de 9 puntos de meta como objetivo, distribuidos de manera aleatoria (dentro de habitaciones, pasillos, salas grandes...) a distancias largas. Cabe señalar que no existe ningún tipo de obstáculo móvil implicado en estas pruebas.

\textbf{Primera prueba}\\
Prueba inicial sin obstáculos adicionales en el entorno.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{c c}
\hline
Puntos de meta &  9 \\
Tiempo total & 20 minutos \\
Metas enviadas & 18 \\
Metas alcanzadas & 18 \\
Tasa metas alcanzadas & 100\% \\
Distancia total & 275.2 metros \\
Nº de choques & 0 \\
\hline
\end{tabular}
}
\caption{Primera prueba de resistencia simulada.}
\label{tabla:primera_prueba_simulada}
\end{table}
La navegación del robot fue correcta durante toda la prueba.

\pagebreak

\textbf{Segunda prueba}\\
Segunda prueba más larga y con obstáculos adicionales en el entorno.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{c c}
\hline
Puntos de meta &  9 \\
Tiempo total & 56 minutos \\
Metas enviadas & 29 \\
Metas alcanzadas & 22 \\
Tasa metas alcanzadas & 75\% \\
Distancia total & 354.6 metros \\
Nº de choques & 0 \\
\hline
\end{tabular}
}
\caption{Segunda prueba de resistencia simulada.}
\label{tabla:segunda_prueba_simulada}
\end{table}
La prueba finalizó debido a que el robot quedó inmobilizado por encontrarse demasiado cerca de una pared frontal y otra lateral. El incremento de tiempo a pesar de no haber recorrido muchos más metros respecto de la prueba anterior se debe a las esperas por reintento en alcanzar las metas fallidas.

A pesar de todo el robot no colisiona con ningún obstáculo.

\textbf{Tercera prueba}\\
Tercera prueba con las mismas características que la anterior. El objetivo de esta prueba era recorrer una distancia total más larga sin colisión.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{c c}
\hline
Puntos de meta &  9 \\
Tiempo total & 23 minutos \\
Metas enviadas & 18 \\
Metas alcanzadas & 15 \\
Tasa metas alcanzadas & 83\% \\
Distancia total & 488.8 metros \\
Nº de choques & 0 \\
\hline
\end{tabular}
}
\caption{Tercera prueba de resistencia simulada.}
\label{tabla:tercera_prueba_simulada}
\end{table}
Las metas no alcanzadas se produjeron por un exceso de tiempo en alcanzarlas, saltando el timeout y abortando la meta objetivo.

Esta prueba nos ofrece resultados de que los planificadores responden bien en el cálculo de trayectorias hacia puntos de meta alejados.

\section{Pruebas reales}
Las pruebas reales se llevaron a cabo en el robot con su configuración hardware y configuración del sistema final. Todos los nodos se ejecutan en el ordenador integrado Intel NUC y se utiliza un ordenador cliente para visualizar datos o teleoperar el robot en caso necesario.

Las pruebas de navegación con y sin mapa se han omitido debido a que los resultados fueron correctos y no se observaron grandes diferencias respecto a los resultados obtenidos en el simulador.

\subsection{SLAM}
Las pruebas reales de SLAM se realiazron en la planta baja y el aparcamiento de la universidad, ya que era de los pocos lugares donde podía realizar un bucle completo.

Para realizar estas pruebas se utilizó al robot en modo de seguimiento y al mismo se realizó el mapeado. Indicar que no existe interferencias en este modo ya que la persona que sirve de guía se encuentra frente al robot y solo es detectada por el sensor Kinect, de tal modo que el sensor láser es el encargado de mapear el entorno sin perturbaciones.

En la figura \ref{fig:slam_real1} se muestra el resultado de la primera prueba.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.9\textwidth]{figuras/slam_real1.png}
\caption{Mapa con la primera prueba de SLAM.}
\label{fig:slam_real1}
\end{figure}
\footnotemark
\footnotetext{\hypersetup{urlcolor=black}
Fuente: \href{https://github.com/danimtb/pioneer3at_ETSIDI/blob/master/pioneer_utils/maps/slam_real1.pgm}{\textit{pioneer\_utils/maps/slam\_real1.pgm}}
\hypersetup{urlcolor=blue}}

El área recuadrada en color rojo indica la zona donde se cerró el bucle y se aprecian ciertas discrepancias en las paredes y un ligero desvío hacia la derecha. Parte de este efecto es debido a que el bucle a cerrar es demasiado grande para esta prueba y a que el robot se desplazó realizando un recorrido sinuoso por el área del parking (se aprecia que se cubrió gran parte del mismo sin ser algo necesario para la prueba), con lo que el error de la odometría pudo haberse visto incrementado.

Debido a estos resultados se decidió realizar una segunda prueba de SLAM en las mismas condiciones pero guiando al robot de una manera más directa a lo largo del bucle (sin giros adicionales).

En la figura \ref{fig:slam_real2} puede apreciarse el resultado de la segunda prueba con el cierre del bucle en la zona recuadrada en rojo. Esta vez el resultado es mejor, ya que no existen grandes discrepancias y el robot es capaz de situarse sin problemas. Tan solo se aprecia una pared exterior duplicada en ángulo, fruto del cierre del mapa.

\begin{figure}[!htp]
\centering
\includegraphics[width=\textwidth]{figuras/slam_real2.png}
\caption{Mapa tras la segunda prueba de SLAM.}
\label{fig:slam_real2}
\end{figure}
\footnotemark
\footnotetext{\hypersetup{urlcolor=black}
Fuente: \href{https://github.com/danimtb/pioneer3at_ETSIDI/blob/master/pioneer_utils/maps/slam_real1.pgm}{\textit{pioneer\_utils/maps/slam\_real1.pgm}}
\hypersetup{urlcolor=blue}}

\subsection{Pruebas de resistencia}
Las pruebas de resistencia se llevaron a cabo en las instalaciones de la planta baja de la universidad.

Se han llevado a cabo mediante el nodo de resistencia creado para el caso y utilizando diversos puntos dentro del mapa "floor\_zero-map"\footnote{\hypersetup{urlcolor=black}Fuente: \href{https://github.com/danimtb/pioneer3at_ETSIDI/blob/master/pioneer_utils/maps/floor_zero-map.pgm}{\textit{pioneer\_utils/maps/floor\_zero-map.pgm}}
\hypersetup{urlcolor=blue}} que abarca las zonas indicadas.

El objetivo primordial de las pruebas es que el robot sea capaz de navegar sin ningún tipo de intervención humana, ya que invalidaría el concepto de robot autónomo.

\textbf{Primera prueba}\\
Primera prueba real desarrollada en el laboratorio con obstáculos y personas en movimiento.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{c c}
\hline
Puntos de meta &  7 \\
Tiempo total & 44 minutos \\
Metas enviadas & 91 \\
Metas alcanzadas & 56 \\
Tasa metas alcanzadas & 61\% \\
Distancia total & - \\
Nº de choques & 0 \\
\hline
\end{tabular}
}
\caption{Primera prueba de resistencia real\protect\footnotemark.}
\label{tabla:primera_prueba_real}
\end{table}
\footnotetext{La distancia total recorrida no pudo contabilizarse debido a un error en la configuración del nodo.}

Los resultados de la primera prueba no reflejan una navegación buena del robot, sin embargo esto es debido a la existencia de obstáculos prominentes no incluidos en el mapa del laboratorio que generaban distorsión en AMCL provocando que el robot quedase mal situado en el mapa. Estos obstáculos generaban a su vez un pasillo estrecho a través del cuál el planificador en ocasiones no era capaz de trazar una trayectoria correcta hasta la meta.

A pesar de ello el robot no colisionó con ningún tipo de obstáculo.

\textbf{Segunda prueba}\\
Segunda prueba de mayor recorrido, con obstáculos adicionales en el entorno y personas en movimiento. El objetivo de la prueba era medir la total movilidad del robot en el laboratorio.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{c c}
\hline
Puntos de meta &  7 \\
Tiempo total & 57 minutos \\
Metas enviadas & 141 \\
Metas alcanzadas & 114 \\
Tasa metas alcanzadas & 80\% \\
Distancia total & 1119.5 metros \\
Nº de choques & 4 \\
\hline
\end{tabular}
}
\caption{Segunda prueba de resistencia real.}
\label{tabla:segunda_prueba_real}
\end{table}
La prueba finalizó por falta de batería en el robot, sin embargo no puede considerarse que ese tiempo sea la duración de la misma en navegación con el robot ya que no se encontraba al 100\%.

Las metas no alcanzadas se produjeron por obstáculos móviles (personas en movimiento) bloqueando el paso del robot (imposible llegar a la meta físicamente). También se produjeron metas abordadas por riesgo de colisión (el robot había quedado situado muy cerca de las patas de una mesa).

Los choques fueron roces leves de las ruedas con obstáculos bajos. Esto es debido a que el planificador ajusta mucho la trayectoria para que el robot pueda navegar por lugares estrechos.

\textbf{Tercera prueba}\\
La segunda prueba de resistencia se planteó como la prueba absoluta, midiendo parámetros como la autonomía de las baterías, con distancias entre puntos más largas, navegación por diferentes salas y pequeños desniveles.

Los puntos de meta preestablecidos se distribuyen en el mapa tal y como se muestra en la figura \ref{fig:endurance_real2} y el root navega aleatoriamente de uno a otro.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.8\textwidth]{figuras/mapa_endurance.png}
\caption{Distribución de puntos de meta en la segunda prueba de resistencia.}
\label{fig:endurance_real2}
\end{figure}

El entorno de la prueba presentó obstáculos altos y bajos (no detectables por el sensor láser), dos pequeñas rampas, personas en continuo movimiento e incluso elementos del entorno cambiados de posición. A continuación se muestran los resultados de la prueba.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{c c}
\hline
Puntos de meta &  17 \\
Tiempo total & 2 horas y 38 minutos \\
Metas enviadas & 164 \\
Metas alcanzadas & 106 \\
Tasa metas alcanzadas & 65\% \\
Distancia total & 4000.5 metros \\
Nº de choques & 2 \\
\hline
\end{tabular}
}
\caption{Tercera prueba de resistencia real.}
\label{tabla:tercera_prueba_real}
\end{table}

Sobre estos resultados cabe decir que el número de metas alcanzadas se ve reducido debido a que en ocasiones se necesita replanificar la ruta hasta el punto de meta y a que el robot a veces encontraba dificultades para conducir su trayectoria a través de pasos estrechos.

La duración de la batería en navegación continua es superior a las dos horas y media. Al finalizar la prueba el voltaje de las baterías alcanzó un valor 10.5 voltios.

En cuanto al número de choques, estos fueron un roce a un obstáculo bajo al tratar de esquivarlo y un choque con las ruedas de una silla.

Destaca el alto valor de la distancia recorrida, que alcanza los 4 kilómetros sin la intervención de una persona, sin que se ponga en riesgo la integridad de ninguna de las personal involucradas en la prueba ni la del propio robot.

\subsection{Ascpectos de la navegación}

Tras las pruebas realizadas, analizando los resultados y observando el comportamiento general de todo el sistema robótico podemos decir que existen algunas limitaciones en la navegación y aspectos que no se tienen en cuenta por las características del robot.

\begin{itemize}
\item \textbf{En cuanto a la navegación:}\\
Existen limitaciones en cuanto a rampas, ya que este modo de navegación no tiene en cuenta la inclinación del robot para saber si este se encuentra desplazándose por un plano inclinado. Por otro lado tampoco es posible distinguir cambios por debajo del plano de navegación como agujeros, escalones... Estos dos aspectos se deben principalmente a que la navegación se realiza puramente en dos dimensiones.

No obstante, el sistema sí es capaz de absorber pequeñas rampas en las que los sensores no reciban excesivas interferencias con el cambio de plano y siempre que el robot no realice muchos giros para no comprometer la localización debido a una mala lectura de la odometría.

\item \textbf{En cuanto a las características del robot:}\\
Ciertos obstáculos bajos no son detectados por los sensores debido a que el robot es capaz de superarlos sin problemas, es por ello que no se ha incidido en detectarlos.

Obstáculos de materiales transparentes, como puertas de cristal, no son detectadas por ninguno de los dos sensores debido a su naturaleza infrarroja, por tanto se definen este tipo de obstáculos como caso límite para el sistema robótico.
\end{itemize}
